name: Repack ROM

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'Direct Link to Recovery ROM'
        required: true
      device_name:
        description: 'Device/Output Name (e.g. xaga)'
        required: true
      compatible_list:
        description: 'Compatible devices (comma-separated, e.g. xaga,xagain,xaga_pro)'
        required: true
      firmware_url:
        description: 'Direct Link to Firmware (Optional)'
        required: false
      preloader_url:
        description: 'Direct Link to Preloader file (Optional, if not in ROM)'
        required: false
      disable_verity:
        description: 'Disable verity/verification on vbmeta (yes/no)'
        required: false
        default: 'yes'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 8192
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Git User Info
        run: |
          git config user.email "bot@github.com"
          git config user.name "GitHub Actions Bot"
        shell: bash

      - name: Install Dependencies
        run: |
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip aria2 p7zip-full zstd dos2unix libxml2-utils
          sudo pip3 install gdown --break-system-packages

      - name: Run Repack Script
        env:
          ROM_URL: ${{ inputs.rom_url }}
          DEVICE_NAME: ${{ inputs.device_name }}
          COMPATIBLE_LIST: ${{ inputs.compatible_list }}
          FIRMWARE_URL: ${{ inputs.firmware_url }}
          PRELOADER_URL: ${{ inputs.preloader_url }}
          DISABLE_VERITY: ${{ inputs.disable_verity }}
        run: |
          echo "Repacking ROM for $DEVICE_NAME"
          chmod +x "$GITHUB_WORKSPACE/scripts/repack.sh"
          # Usage: repack.sh URL WORKSPACE DEVICE KEY FIRMWARE_URL
          sudo -E bash "$GITHUB_WORKSPACE/scripts/repack.sh" "$ROM_URL" "$GITHUB_WORKSPACE" "$DEVICE_NAME" "" "$FIRMWARE_URL"
          
          if [ $? -ne 0 ]; then
            echo "Error: Build failed."
            exit 1
          fi

      - name: Generate Release Info
        id: release_info
        run: |
          echo "TAG_NAME=${{ inputs.device_name }}-$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          # Prepend explanatory text to the link file for the body
          if [ -f "$GITHUB_WORKSPACE/gofile_link.txt" ]; then
             echo -e "Automated build.\nDownload your ROM here: $(cat $GITHUB_WORKSPACE/gofile_link.txt)" > release_notes.txt
          else
             echo "Automated build. Download link unavailable." > release_notes.txt
          fi

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.TAG_NAME }}
          name: "Fastboot ROM for ${{ inputs.device_name }}"
          bodyFile: release_notes.txt
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          makeLatest: true
